<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Domes Music Library</title>
    <style>
        body {
            font-family: Times, serif;
            font-size: 12px;
            background: white;
            color: black;
            margin: 8px;
            line-height: 1.2;
        }

        h1 {
            font-size: 18px;
            margin: 0 0 8px 0;
            text-align: center;
        }

        h2 {
            font-size: 14px;
            margin: 12px 0 6px 0;
        }

        h3 {
            font-size: 12px;
            margin: 8px 0 4px 0;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            border: 1px solid black;
        }

        th, td {
            border: 1px solid black;
            padding: 4px;
            text-align: left;
            vertical-align: top;
        }
        .modal-content table td {
    height: auto;
    word-wrap: break-word;
    white-space: normal;
    vertical-align: top;
    min-height: 20px;
}


        th {
            background: #cccccc;
            font-weight: bold;
        }

        tr:nth-child(even) {
            background: #f0f0f0;
        }

        .header {
            text-align: center;
            border: 2px solid black;
            padding: 8px;
            margin-bottom: 16px;
            background: #eeeeee;
        }

        .nav {
            text-align: center;
            margin: 8px 0;
        }

        .nav a {
            color: blue;
            text-decoration: underline;
            margin: 0 8px;
        }

        .nav a:visited {
            color: purple;
        }

        input, select, textarea {
            font-family: Times, serif;
            font-size: 12px;
            border: 1px solid black;
            padding: 2px;
        }

        input[type="submit"], button {
            background: #dddddd;
            border: 2px outset #dddddd;
            padding: 4px 8px;
            cursor: pointer;
            font-family: Times, serif;
            font-size: 12px;
        }

        input[type="submit"]:active, button:active {
            border: 2px inset #dddddd;
        }

        input[type="submit"]:disabled, button:disabled {
            background: #aaaaaa;
            cursor: not-allowed;
        }

        .album-row {
            border-bottom: 1px solid black;
            padding: 8px 0;
            margin: 8px 0;
            position: relative;
        }

        .album-info {
            margin: 0;
        }

        .rating {
            font-weight: bold;
            background: yellow;
            padding: 2px 4px;
            border-radius: 3px;
            display: inline-block;
            min-width: 40px;
            text-align: center;
            font-size: 11px;
        }

        .delete-album {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #ff4444;
            color: white;
            border: none;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 10px;
            border-radius: 3px;
        }

        .delete-album:hover {
            background: #cc0000;
        }

        .admin-panel {
            display: none;
            border: 2px solid black;
            padding: 12px;
            margin: 16px 0;
            background: #f8f8f8;
        }

        .setup-panel {
            display: none;
            border: 2px solid red;
            padding: 12px;
            margin: 16px 0;
            background: #ffe0e0;
        }

        .setup-section {
            border: 1px solid #666;
            padding: 8px;
            margin: 8px 0;
            background: #f8f8f8;
        }

        .form-table {
            width: 100%;
        }

        .form-table td {
            padding: 4px;
            border: none;
        }

        .form-table input, .form-table select, .form-table textarea {
            width: 100%;
        }

        .track-list {
            margin: 8px 0;
        }

        .track-item {
            margin: 4px 0;
            padding: 4px;
            border: 1px solid #ccc;
            background: white;
        }

        /* Verbessertes Rating Design f√ºr Track-Felder */
        .track-rating {
            width: 60px !important;
            font-family: "Courier New", monospace !important;
            text-align: center;
            font-weight: bold;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 16px;
            border: 2px solid black;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            color: black;
            float: right;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            background: #dddddd;
            border: 1px solid black;
            padding: 2px 6px;
        }

        .filter-section {
            border: 1px solid black;
            padding: 8px;
            margin: 8px 0;
            background: #f0f0f0;
        }

        .blink {
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        center {
            text-align: center;
        }

        hr {
            border: none;
            border-top: 1px solid black;
            margin: 8px 0;
        }

        marquee {
            background: yellow;
            border: 1px solid black;
            padding: 4px;
            margin: 8px 0;
        }

        .counter {
            font-family: "Courier New", monospace;
            background: black;
            color: lime;
            padding: 2px 4px;
            border: 1px solid black;
        }

        .status {
            background: #e0ffe0;
            border: 1px solid green;
            padding: 4px;
            margin: 4px 0;
        }

        .error {
            background: #ffe0e0;
            border: 1px solid red;
            padding: 4px;
            margin: 4px 0;
            color: red;
        }

        .loading {
            background: #ffffcc;
            border: 1px solid orange;
            padding: 4px;
            margin: 4px 0;
        }

        .public-notice {
            background: #e6f3ff;
            border: 2px solid #0066cc;
            padding: 8px;
            margin: 8px 0;
            text-align: center;
        }

        .auto-refresh-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #f0f0f0;
            border: 1px solid #ccc;
            padding: 4px 8px;
            font-size: 10px;
            border-radius: 3px;
            z-index: 100;
        }
    </style>
</head>
<body>
    <div class="auto-refresh-status" id="refreshStatus">Auto-Refresh: Aktiv</div>

    <div class="header">
        <h1>üéµ DOMES MUSIC LIBRARY üéµ</h1>
        <p><b>Bewertete Alben:</b> <span class="counter" id="albumCount">000</span></p>
        <p>
            <a href="#" onclick="toggleLogin()" id="loginLink">*** ADMIN LOGIN ***</a>
        </p>
        <div id="connectionStatus"></div>
    </div>

    <marquee>‚òÖ Willkommen in meiner pers√∂nlichen Musiksammlung! √ñffentlich zug√§nglich √ºber GitHub Pages! ‚òÖ</marquee>

    <!-- Admin Panel -->
    <div id="adminPanel" class="admin-panel">
        <h2>‚ïê‚ïê‚ïê ADMIN BEREICH ‚ïê‚ïê‚ïê</h2>
        
        <!-- GitHub Setup (nur im Admin sichtbar) -->
        <div class="setup-section">
            <h3>üîß GitHub Konfiguration:</h3>
            <table class="form-table">
                <tr>
                    <td width="120"><b>GitHub Username:</b></td>
                    <td><input type="text" id="githubUsername" placeholder="dein-github-username"></td>
                </tr>
                <tr>
                    <td><b>Repository Name:</b></td>
                    <td><input type="text" id="githubRepo" placeholder="music-library"></td>
                </tr>
                <tr>
                    <td><b>GitHub Token:</b></td>
                    <td><input type="password" id="githubToken" placeholder="ghp_..."></td>
                </tr>
            </table>
            
            <p>
                <button type="button" onclick="saveGitHubConfig()">üíæ Konfiguration speichern</button>
                <button type="button" onclick="testConnection()">üîß Verbindung testen</button>
            </p>
            
            <details>
                <summary><b>‚ùì Setup-Anleitung f√ºr √∂ffentlichen Zugang:</b></summary>
                <div style="background: white; padding: 8px; border: 1px solid #ccc; margin: 4px 0;">
                    <h4>1. GitHub Token erstellen:</h4>
                    <ol style="font-size: 11px; margin: 8px 0;">
                        <li>Gehe zu <b>GitHub.com ‚Üí Settings ‚Üí Developer settings</b></li>
                        <li><b>Personal access tokens ‚Üí Tokens (classic)</b></li>
                        <li>Klick <b>"Generate new token (classic)"</b></li>
                        <li>Name: <b>"Music Library"</b></li>
                        <li>Expiration: <b>"No expiration"</b></li>
                        <li>Scopes: ‚úÖ <b>repo</b> (full control of repositories)</li>
                        <li><b>Token generieren und kopieren!</b></li>
                    </ol>

                    <h4>2. Repository f√ºr √∂ffentlichen Zugang einrichten:</h4>
                    <ol style="font-size: 11px; margin: 8px 0;">
                        <li>Repository erstellen oder √∂ffnen</li>
                        <li><b>Settings ‚Üí Pages</b></li>
                        <li>Source: <b>"Deploy from a branch"</b></li>
                        <li>Branch: <b>"main" / "master"</b></li>
                        <li>Diese HTML-Datei als <b>"index.html"</b> in dein Repository hochladen</li>
                        <li>URL wird sein: <b>https://[username].github.io/[repository-name]</b></li>
                    </ol>

                    <h4>3. Sicherheit:</h4>
                    <p style="font-size: 11px;">
                        ‚Ä¢ <b>Passwort:</b> Standard ist "admin123" (SHA-256 gehasht)<br>
                        ‚Ä¢ <b>DDoS-Schutz:</b> Max. 3 Login-Versuche, dann 5 Min Sperre<br>
                        ‚Ä¢ <b>Token-Schutz:</b> GitHub Token nur lokal gespeichert
                    </p>
                </div>
            </details>
            
            <div id="setupStatus"></div>
            <hr>
        </div>
        
        <h3>MusicBrainz Suche:</h3>
        <table class="form-table">
            <tr>
                <td>Suche:</td>
                <td><input type="text" id="searchQuery" placeholder="Album oder K√ºnstler..."></td>
                <td><button onclick="searchMusicBrainz()">Suchen</button></td>
            </tr>
        </table>
        <div id="searchResults" style="display: none; border: 1px solid black; background: white; max-height: 120px; overflow-y: auto;"></div>

        <hr>

        <form onsubmit="addAlbum(event)">
            <table class="form-table">
                <tr>
                    <td width="80"><b>Album:</b></td>
                    <td><input type="text" id="albumTitle" required></td>
                    <td width="80"><b>K√ºnstler:</b></td>
                    <td><input type="text" id="albumArtist" required></td>
                </tr>
                <tr>
                    <td><b>Jahr:</b></td>
                    <td><input type="number" id="albumYear" min="1900" max="2025"></td>
                    <td><b>Genre:</b></td>
                    <td><input type="text" id="albumGenre"></td>
                </tr>

                <tr>
                    <td><b>Review:</b></td>
                    <td colspan="3"><textarea id="albumReview" rows="3" required></textarea></td>
                </tr>
            </table>

            <div id="tracksContainer">
                <h3>Songs:</h3>
                <button type="button" onclick="addTrackField()">+ Song hinzuf√ºgen</button>
            </div>

            <p><input type="submit" value="‚òÖ ALBUM SPEICHERN ‚òÖ" id="saveButton"></p>
        </form>
        
        <div id="saveStatus"></div>
    </div>

    <!-- Filters -->
    <div class="filter-section">
        <h3>‚ïê‚ïê‚ïê FILTER & SUCHE ‚ïê‚ïê‚ïê</h3>
        <table width="100%">
            <tr>
                <td>Suche:</td>
                <td><input type="text" id="searchFilter" placeholder="Suchen..." onkeyup="applyFilters()"></td>
                <td>Sortierung:</td>
                <td>
                    <select id="sortFilter" onchange="applyFilters()">
                        <option value="newest">Neueste zuerst</option>
                        <option value="oldest">√Ñlteste zuerst</option>
                        <option value="rating-high">Beste Bewertung</option>
                        <option value="rating-low">Schlechteste Bewertung</option>
                        <option value="artist">K√ºnstler A-Z</option>
                        <option value="title">Titel A-Z</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td>Genre:</td>
                <td><select id="genreFilter" onchange="applyFilters()"><option value="">Alle</option></select></td>
                <td>Jahr:</td>
                <td><select id="yearFilter" onchange="applyFilters()"><option value="">Alle</option></select></td>
            </tr>
        </table>
    </div>

    <hr>

    <!-- Albums List -->
    <div id="albumsList">
        <center>
            <div class="loading">
                <h2>Loading...</h2>
            </div>
        </center>
    </div>

    <!-- Album Detail Modal -->
    <div id="albumModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">‚úñ</span>
            <div id="modalContent"></div>
        </div>
    </div>

    <hr>
    <center>
        <p><small>¬© 2025 Domes Music Library | <span class="blink">‚òÖ √ñffentlich √ºber GitHub Pages ‚òÖ</span></small></p>
    </center>

    <script>
        // Configuration
        let config = {
            githubUsername: '',
            githubRepo: '',
            githubToken: ''
        };

        // Data storage
        let albums = [];
        let isLoggedIn = false;
        let trackCounter = 0;
        let loginAttempts = 0;
        let lockoutEndTime = 0;
        let refreshInterval;
        let loginExpireTimeout;

        // Password hash (SHA-256 of "admin123")
        const ADMIN_HASH = "240be518fabd2724ddb6f04eeb1da5967448d7e831c08c8fa822809f74c720a9";

        // Demo data for fallback
        const demoAlbums = [
            {
                id: 1,
                title: "OK Computer",
                artist: "Radiohead",
                year: 1997,
                genre: "Alternative Rock",
                review: "Ein Meisterwerk des experimentellen Rocks. Thom Yorkes eindringliche Stimme und die innovativen Produktionstechniken machen dieses Album zu einem zeitlosen Klassiker.",
                rating: 9.5,
                dateAdded: "2025-01-15T10:00:00Z",
                tracks: [
                    { title: "Airbag", rating: 8.5, comment: "Kraftvoller Opener" },
                    { title: "Paranoid Android", rating: 10, comment: "Absolute Perfektion" },
                    { title: "Subterranean Homesick Alien", rating: 8, comment: "Atmosph√§risch" },
                    { title: "Exit Music (For a Film)", rating: 9, comment: "Emotional ber√ºhrend" },
                    { title: "Let Down", rating: 9.5, comment: "Untersch√§tzt" }
                ]
            },
            {
                id: 2,
                title: "Random Access Memories",
                artist: "Daft Punk",
                year: 2013,
                genre: "Electronic",
                review: "Eine Hommage an die Disco-√Ñra mit modernen elektronischen Elementen. Perfekte Produktion und nostalgische Vibes.",
                rating: 8.7,
                dateAdded: "2025-01-14T14:30:00Z",
                tracks: [
                    { title: "Give Life Back to Music", rating: 8, comment: "Groovy Start" },
                    { title: "The Game of Love", rating: 7.5, comment: "Smooth" },
                    { title: "Giorgio by Moroder", rating: 9, comment: "Episch" },
                    { title: "Get Lucky", rating: 9, comment: "Hit!" }
                ]
            }
        ];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadConfig();
            checkInitialState();
            startAutoRefresh();
            restoreLoginState();
        });

        // Auto-refresh functionality
        function startAutoRefresh() {
            refreshInterval = setInterval(() => {
                loadAlbumsPublicly();
                updateRefreshStatus();
            }, 5 * 60 * 1000); // 5 minutes
            
            updateRefreshStatus();
        }

        function updateRefreshStatus() {
            const now = new Date();
            document.getElementById('refreshStatus').textContent = `Auto-Refresh: ${now.toLocaleTimeString()}`;
        }

        // Login state persistence
        function saveLoginState() {
            if (isLoggedIn) {
                const loginTime = Date.now();
                localStorage.setItem('adminLoginTime', loginTime.toString());
                localStorage.setItem('adminLoggedIn', 'true');
                
                // Set timeout to auto-logout after 5 minutes
                if (loginExpireTimeout) {
                    clearTimeout(loginExpireTimeout);
                }
                loginExpireTimeout = setTimeout(() => {
                    logout();
                    alert('Admin-Sitzung abgelaufen. Bitte erneut einloggen.');
                }, 5 * 60 * 1000);
            } else {
                localStorage.removeItem('adminLoginTime');
                localStorage.removeItem('adminLoggedIn');
                if (loginExpireTimeout) {
                    clearTimeout(loginExpireTimeout);
                }
            }
        }

        function restoreLoginState() {
            const loginTime = localStorage.getItem('adminLoginTime');
            const wasLoggedIn = localStorage.getItem('adminLoggedIn') === 'true';
            
            if (wasLoggedIn && loginTime) {
                const timeSinceLogin = Date.now() - parseInt(loginTime);
                const fiveMinutes = 5 * 60 * 1000;
                
                if (timeSinceLogin < fiveMinutes) {
                    // Still within 5 minute window, restore login
                    isLoggedIn = true;
                    document.getElementById('loginLink').textContent = '*** ADMIN LOGOUT ***';
                    document.getElementById('adminPanel').style.display = 'block';
                    
                    // Load current config into setup fields
                    document.getElementById('githubUsername').value = config.githubUsername || '';
                    document.getElementById('githubRepo').value = config.githubRepo || '';
                    document.getElementById('githubToken').value = config.githubToken || '';
                    
                    // Set timeout for remaining time
                    const remainingTime = fiveMinutes - timeSinceLogin;
                    loginExpireTimeout = setTimeout(() => {
                        logout();
                        alert('Admin-Sitzung abgelaufen. Bitte erneut einloggen.');
                    }, remainingTime);
                } else {
                    // Expired, clear storage
                    localStorage.removeItem('adminLoginTime');
                    localStorage.removeItem('adminLoggedIn');
                }
            }
        }

        // Configuration management
        function loadConfig() {
            const saved = localStorage.getItem('githubConfig');
            if (saved) {
                try {
                    config = JSON.parse(saved);
                } catch (e) {
                    console.error('Invalid config in localStorage:', e);
                    localStorage.removeItem('githubConfig');
                }
            }
        }

        function checkInitialState() {
            // Always try to load albums publicly first
            loadAlbumsPublicly();
        }

        // NEW: Public loading function (no authentication required)
        async function loadAlbumsPublicly() {
            try {
                // Try to determine GitHub info from current URL if on GitHub Pages
                let username = config.githubUsername;
                let repo = config.githubRepo;
                
                // Auto-detect from GitHub Pages URL
                if (window.location.hostname.includes('github.io')) {
                    const parts = window.location.hostname.split('.');
                    if (parts.length >= 3 && parts[1] === 'github' && parts[2] === 'io') {
                        username = parts[0];
                        const pathParts = window.location.pathname.split('/').filter(p => p);
                        if (pathParts.length > 0) {
                            repo = pathParts[0];
                        }
                    }
                }

                if (username && repo) {
                    // Try to load from public GitHub URL (raw content)
                    const publicUrl = `https://raw.githubusercontent.com/${username}/${repo}/main/albums.json`;
                    
                    try {
                        const response = await fetch(publicUrl);
                        if (response.ok) {
                            const data = await response.text();
                            const newAlbums = JSON.parse(data);
                            
                            // Check if we have new albums
                            if (albums.length > 0 && newAlbums.length > albums.length) {
                                document.getElementById('connectionStatus').innerHTML = '<div class="status">üÜï Neue Alben gefunden!</div>';
                                setTimeout(() => document.getElementById('connectionStatus').innerHTML = '', 3000);
                            }
                            
                            albums = newAlbums;
                            updateAlbumCount();
                            displayAlbums();
                            updateFilters();
                            
                            return;
                        }
                    } catch (error) {
                        console.log('Public loading failed, trying with auth...', error);
                    }
                }

                // Fallback: Try with authentication if configured
                if (isConfigured()) {
                    await loadAlbumsFromGitHub();
                    return;
                }

                // Last fallback: Show demo data
                if (albums.length === 0) {
                    showDemoData();
                }
                
            } catch (error) {
                console.error('Public loading error:', error);
                if (albums.length === 0) {
                    showDemoData();
                }
            }
        }

        function showDemoData() {
            albums = [...demoAlbums];
            updateAlbumCount();
            displayAlbums();
            updateFilters();
            
            document.getElementById('connectionStatus').innerHTML = '<div class="loading">üìç Demo-Daten | F√ºr Live-Daten: GitHub konfigurieren</div>';
        }

        function isConfigured() {
            return config.githubUsername && config.githubRepo && config.githubToken;
        }

        // GitHub config functions (now in admin panel)
        function saveGitHubConfig() {
            const username = document.getElementById('githubUsername').value.trim();
            const repo = document.getElementById('githubRepo').value.trim();
            const token = document.getElementById('githubToken').value.trim();

            if (!username || !repo || !token) {
                document.getElementById('setupStatus').innerHTML = '<div class="error">‚ùå Bitte alle Felder ausf√ºllen!</div>';
                return;
            }

            // Validate token format
            if (!token.startsWith('ghp_') && !token.startsWith('github_pat_')) {
                document.getElementById('setupStatus').innerHTML = '<div class="error">‚ùå Token muss mit "ghp_" oder "github_pat_" beginnen!</div>';
                return;
            }

            config.githubUsername = username;
            config.githubRepo = repo;
            config.githubToken = token;

            localStorage.setItem('githubConfig', JSON.stringify(config));
            
            document.getElementById('setupStatus').innerHTML = '<div class="status">‚úÖ Konfiguration gespeichert!</div>';
            
            setTimeout(() => {
                testConnection();
            }, 500);
        }

        async function testConnection() {
            if (!isConfigured()) {
                document.getElementById('setupStatus').innerHTML = '<div class="error">‚ùå Bitte zuerst Konfiguration speichern!</div>';
                return;
            }

            document.getElementById('setupStatus').innerHTML = '<div class="loading">üîÑ Teste Verbindung...</div>';

            try {
                const response = await fetch(`https://api.github.com/repos/${config.githubUsername}/${config.githubRepo}`, {
                    headers: {
                        'Authorization': `token ${config.githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (response.ok) {
                    document.getElementById('setupStatus').innerHTML = '<div class="status">‚úÖ GitHub-Verbindung erfolgreich! Repository gefunden.</div>';
                    
                    // Initialize repository after successful connection
                    await initializeRepository();
                } else if (response.status === 404) {
                    document.getElementById('setupStatus').innerHTML = '<div class="error">‚ùå Repository nicht gefunden! Pr√ºfe Username und Repository-Name.</div>';
                } else if (response.status === 401) {
                    document.getElementById('setupStatus').innerHTML = '<div class="error">‚ùå Token ung√ºltig! Erstelle ein neues Token mit "repo" Berechtigung.</div>';
                } else {
                    document.getElementById('setupStatus').innerHTML = '<div class="error">‚ùå Verbindungsfehler (Status: ' + response.status + ')</div>';
                }
            } catch (error) {
                console.error('Connection test error:', error);
                document.getElementById('setupStatus').innerHTML = '<div class="error">‚ùå Netzwerkfehler: ' + error.message + '</div>';
            }
        }

        // GitHub API functions
        async function initializeRepository() {
            try {
                // Check if albums.json exists
                const response = await fetch(`https://api.github.com/repos/${config.githubUsername}/${config.githubRepo}/contents/albums.json`, {
                    headers: {
                        'Authorization': `token ${config.githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!response.ok) {
                    // Create initial albums.json
                    await createAlbumsFile([]);
                    document.getElementById('connectionStatus').innerHTML = '<div class="status">‚úÖ Repository initialisiert!</div>';
                }
                
                loadAlbumsFromGitHub();
            } catch (error) {
                console.error('Repository initialization error:', error);
                document.getElementById('connectionStatus').innerHTML = '<div class="error">Fehler beim Initialisieren: ' + error.message + '</div>';
            }
        }

        async function loadAlbumsFromGitHub() {
            if (!isConfigured()) return;

            try {
                const response = await fetch(`https://api.github.com/repos/${config.githubUsername}/${config.githubRepo}/contents/albums.json`, {
                    headers: {
                        'Authorization': `token ${config.githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const content = atob(data.content);
                    albums = JSON.parse(content);
                    
                    updateAlbumCount();
                    displayAlbums();
                    updateFilters();
                    
                    document.getElementById('connectionStatus').innerHTML = '<div class="status">‚úÖ Alben mit Auth geladen</div>';
                    setTimeout(() => document.getElementById('connectionStatus').innerHTML = '', 2000);
                } else {
                    throw new Error('Alben konnten nicht geladen werden');
                }
            } catch (error) {
                console.error('Load error:', error);
                // Fallback to public loading
                loadAlbumsPublicly();
            }
        }

        async function saveAlbumsToGitHub() {
            if (!isConfigured()) return false;

            try {
                // Get current file to get SHA
                const currentResponse = await fetch(`https://api.github.com/repos/${config.githubUsername}/${config.githubRepo}/contents/albums.json`, {
                    headers: {
                        'Authorization': `token ${config.githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                let sha = null;
                if (currentResponse.ok) {
                    const currentData = await currentResponse.json();
                    sha = currentData.sha;
                }

                // Update file
                const content = btoa(JSON.stringify(albums, null, 2));
                const updateResponse = await fetch(`https://api.github.com/repos/${config.githubUsername}/${config.githubRepo}/contents/albums.json`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${config.githubToken}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Update albums.json - ${new Date().toISOString()}`,
                        content: content,
                        sha: sha
                    })
                });

                if (updateResponse.ok) {
                    return true;
                } else {
                    const errorData = await updateResponse.json();
                    throw new Error(errorData.message || 'GitHub API Error');
                }
            } catch (error) {
                console.error('Save error:', error);
                return false;
            }
        }

        async function createAlbumsFile(initialData) {
            const content = btoa(JSON.stringify(initialData, null, 2));
            
            await fetch(`https://api.github.com/repos/${config.githubUsername}/${config.githubRepo}/contents/albums.json`, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${config.githubToken}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: 'Initialize albums.json',
                    content: content
                })
            });
        }

        // Authentication
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hash = await crypto.subtle.digest('SHA-256', data);
            return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        function isLockedOut() {
            return Date.now() < lockoutEndTime;
        }

        function getRemainingLockoutTime() {
            return Math.ceil((lockoutEndTime - Date.now()) / 1000);
        }

        async function toggleLogin() {
            if (isLoggedIn) {
                logout();
            } else {
                if (isLockedOut()) {
                    alert(`‚õî Zu viele fehlgeschlagene Versuche! Warte noch ${getRemainingLockoutTime()} Sekunden.`);
                    return;
                }

                const password = prompt('ADMIN PASSWORT:');
                if (password === null) return; // User cancelled
                
                if (password === '') {
                    alert('Bitte ein Passwort eingeben!');
                    return;
                }

                const hashedInput = await hashPassword(password);
                
                if (hashedInput === ADMIN_HASH) {
                    loginAttempts = 0;
                    login();
                } else {
                    loginAttempts++;
                    const remainingAttempts = 3 - loginAttempts;
                    
                    if (loginAttempts >= 3) {
                        lockoutEndTime = Date.now() + (5 * 60 * 1000); // 5 minutes lockout
                        alert('‚ùå FALSCHES PASSWORT!\n\n‚õî 3 fehlgeschlagene Versuche erreicht!\nZugang gesperrt f√ºr 5 Minuten.');
                    } else {
                        alert(`‚ùå FALSCHES PASSWORT!\n\nNoch ${remainingAttempts} Versuche √ºbrig.`);
                    }
                }
            }
        }

        function login() {
            isLoggedIn = true;
            document.getElementById('loginLink').textContent = '*** ADMIN LOGOUT ***';
            document.getElementById('adminPanel').style.display = 'block';
            
            // Load current config into setup fields
            document.getElementById('githubUsername').value = config.githubUsername || '';
            document.getElementById('githubRepo').value = config.githubRepo || '';
            document.getElementById('githubToken').value = config.githubToken || '';
            
            saveLoginState();
        }

        function logout() {
            isLoggedIn = false;
            document.getElementById('loginLink').textContent = '*** ADMIN LOGIN ***';
            document.getElementById('adminPanel').style.display = 'none';
            saveLoginState();
        }

        // MusicBrainz API Search
        async function searchMusicBrainz() {
            const query = document.getElementById('searchQuery').value;
            if (!query) return;

            try {
                const response = await fetch(`https://musicbrainz.org/ws/2/release/?query=${encodeURIComponent(query)}&limit=8&fmt=json`);
                const data = await response.json();
                
                const resultsDiv = document.getElementById('searchResults');
                resultsDiv.innerHTML = '';
                resultsDiv.style.display = 'block';

                data.releases.forEach(release => {
                    const div = document.createElement('div');
                    div.style.padding = '4px';
                    div.style.borderBottom = '1px solid #ccc';
                    div.style.cursor = 'pointer';
                    div.innerHTML = `<b>${release.title}</b> - ${release['artist-credit'] ? release['artist-credit'][0].name : 'unbekannt'} ${release.date ? `(${release.date.substring(0, 4)})` : ''}`;
                    div.onclick = () => selectAlbum(release);
                    resultsDiv.appendChild(div);
                });
            } catch (error) {
                console.error('MusicBrainz Fehler:', error);
                alert('Fehler bei der Suche!');
            }
        }

        async function selectAlbum(release) {
            document.getElementById('albumTitle').value = release.title;
            document.getElementById('albumArtist').value = release['artist-credit'] ? release['artist-credit'][0].name : '';
            document.getElementById('albumYear').value = release.date ? release.date.substring(0, 4) : '';
            
            document.getElementById('searchResults').style.display = 'none';

            // Try to get tracks
            try {
                const response = await fetch(`https://musicbrainz.org/ws/2/release/${release.id}?inc=recordings&fmt=json`);
                const data = await response.json();
                
                // Clear existing tracks
                const container = document.getElementById('tracksContainer');
                const existingTracks = container.querySelectorAll('.track-field');
                existingTracks.forEach(track => track.remove());
                
                // Add tracks
                if (data.media && data.media[0] && data.media[0].tracks) {
                    data.media[0].tracks.forEach(track => {
                        addTrackField(track.title);
                    });
                }
            } catch (error) {
                console.error('Track-Fehler:', error);
            }
        }

        // Track management
        function addTrackField(title = '') {
            const container = document.getElementById('tracksContainer');
            const trackDiv = document.createElement('div');
            trackDiv.className = 'track-field track-item';
            trackDiv.innerHTML = `
                <table width="100%">
                    <tr>
                        <td width="200">Song:</td>
                        <td><input type="text" class="track-title" value="${title}" required></td>
                        <td width="80">Rating:</td>
                        <td width="60"><input type="number" class="track-rating" min="0" max="10" step="0.1" required></td>
                        <td width="60"><button type="button" onclick="this.closest('.track-field').remove()">DEL</button></td>
                    </tr>
                    <tr>
                        <td>Kommentar:</td>
                        <td colspan="4"><input type="text" class="track-comment" maxlength="100"></td>
                    </tr>
                </table>
            `;
            container.appendChild(trackDiv);
        }

        // Album management
        async function addAlbum(event) {
            event.preventDefault();
            
            if (!isConfigured()) {
                alert('GitHub Setup ist erforderlich zum Speichern!');
                return;
            }
            
            const saveButton = document.getElementById('saveButton');
            const statusDiv = document.getElementById('saveStatus');
            
            saveButton.disabled = true;
            saveButton.value = 'SPEICHERE...';
            statusDiv.innerHTML = '<div class="loading">Speichere Album auf GitHub...</div>';
            
            try {
                const tracks = [];
                const trackFields = document.querySelectorAll('.track-field');
                
                trackFields.forEach(field => {
                    const title = field.querySelector('.track-title').value;
                    const rating = parseFloat(field.querySelector('.track-rating').value);
                    const comment = field.querySelector('.track-comment').value;
                    
                    tracks.push({ title, rating, comment });
                });

                const album = {
                    id: Date.now(),
                    title: document.getElementById('albumTitle').value,
                    artist: document.getElementById('albumArtist').value,
                    year: parseInt(document.getElementById('albumYear').value) || null,
                    genre: document.getElementById('albumGenre').value,
                    review: document.getElementById('albumReview').value,
                    tracks: tracks,
                    rating: tracks.length > 0 ? Math.round((tracks.reduce((sum, track) => sum + track.rating, 0) / tracks.length) * 10) / 10 : 0,
                    dateAdded: new Date().toISOString()
                };

                albums.push(album);
                
                const success = await saveAlbumsToGitHub();
                
                if (success) {
                    // Clear form
                    document.querySelector('form').reset();
                    document.querySelectorAll('.track-field').forEach(field => field.remove());
                    
                    updateAlbumCount();
                    displayAlbums();
                    updateFilters();
                    
                    statusDiv.innerHTML = '<div class="status">‚úÖ Album erfolgreich gespeichert!</div>';
                    setTimeout(() => statusDiv.innerHTML = '', 3000);
                } else {
                    albums.pop(); // Remove the album we just added
                    statusDiv.innerHTML = '<div class="error">‚ùå Fehler beim Speichern auf GitHub!</div>';
                }
            } catch (error) {
                console.error('Add album error:', error);
                statusDiv.innerHTML = '<div class="error">‚ùå Fehler: ' + error.message + '</div>';
            } finally {
                saveButton.disabled = false;
                saveButton.value = '‚òÖ ALBUM SPEICHERN ‚òÖ';
            }
        }

        // Album deletion function
        async function deleteAlbum(albumId) {
            if (!isLoggedIn) {
                alert('Du musst als Admin eingeloggt sein!');
                return;
            }

            const album = albums.find(a => a.id === albumId);
            if (!album) return;

            if (!confirm(`Album "${album.title}" von ${album.artist} wirklich l√∂schen?`)) {
                return;
            }

            try {
                // Remove from array
                albums = albums.filter(a => a.id !== albumId);
                
                // Save to GitHub
                const success = await saveAlbumsToGitHub();
                
                if (success) {
                    updateAlbumCount();
                    displayAlbums();
                    updateFilters();
                    
                    document.getElementById('connectionStatus').innerHTML = '<div class="status">‚úÖ Album gel√∂scht!</div>';
                    setTimeout(() => document.getElementById('connectionStatus').innerHTML = '', 2000);
                } else {
                    // Restore album if save failed
                    albums.push(album);
                    alert('Fehler beim L√∂schen des Albums!');
                }
            } catch (error) {
                console.error('Delete error:', error);
                albums.push(album); // Restore album
                alert('Fehler beim L√∂schen: ' + error.message);
            }
        }
        
        function updateAlbumCount() {
            document.getElementById('albumCount').textContent = albums.length.toString().padStart(3, '0');
        }

        function displayAlbums() {
            const container = document.getElementById('albumsList');
            
            if (albums.length === 0) {
                container.innerHTML = `
                    <center>
                        <h2>Noch keine Alben vorhanden!</h2>
                        <p>Logge dich als Admin ein, um Alben hinzuzuf√ºgen.</p>
                    </center>
                `;
                return;
            }

            let filteredAlbums = [...albums];
            
            // Apply filters
            const searchTerm = document.getElementById('searchFilter').value.toLowerCase();
            const genreFilter = document.getElementById('genreFilter').value;
            const yearFilter = document.getElementById('yearFilter').value;
            const sortFilter = document.getElementById('sortFilter').value;

            if (searchTerm) {
                filteredAlbums = filteredAlbums.filter(album => 
                    album.title.toLowerCase().includes(searchTerm) || 
                    album.artist.toLowerCase().includes(searchTerm)
                );
            }

            if (genreFilter) {
                filteredAlbums = filteredAlbums.filter(album => album.genre === genreFilter);
            }

            if (yearFilter) {
                filteredAlbums = filteredAlbums.filter(album => album.year == yearFilter);
            }

            // Sort albums
            filteredAlbums.sort((a, b) => {
                switch (sortFilter) {
                    case 'oldest':
                        return new Date(a.dateAdded) - new Date(b.dateAdded);
                    case 'rating-high':
                        return b.rating - a.rating;
                    case 'rating-low':
                        return a.rating - b.rating;
                    case 'artist':
                        return a.artist.localeCompare(b.artist);
                    case 'title':
                        return a.title.localeCompare(b.title);
                    default: // newest
                        return new Date(b.dateAdded) - new Date(a.dateAdded);
                }
            });

            container.innerHTML = filteredAlbums.map(album => `
                <div class="album-row" onclick="openAlbumDetail(${album.id})" style="cursor: pointer;">
                    ${isLoggedIn ? `<button class="delete-album" onclick="event.stopPropagation(); deleteAlbum(${album.id})">üóëÔ∏è DEL</button>` : ''}
                    <div class="album-info">
                        <h3><u>${album.title}</u> - ${album.artist} <span class="rating">${album.rating.toFixed(1)}/10</span></h3>
                        <p><b>Review:</b> ${album.review.length > 150 ? album.review.substring(0, 150) + '...' : album.review}</p>
                        <p><small>
                            ${album.year ? `Jahr: ${album.year} | ` : ''}
                            ${album.genre ? `Genre: ${album.genre} | ` : ''}
                            Songs: ${album.tracks.length}
                        </small></p>
                    </div>
                </div>
            `).join('');
        }

        function applyFilters() {
            displayAlbums();
        }

        function updateFilters() {
            // Update genre filter
            const genres = [...new Set(albums.map(album => album.genre).filter(Boolean))].sort();
            const genreSelect = document.getElementById('genreFilter');
            genreSelect.innerHTML = '<option value="">Alle</option>' + 
                genres.map(genre => `<option value="${genre}">${genre}</option>`).join('');

            // Update year filter
            const years = [...new Set(albums.map(album => album.year).filter(Boolean))].sort((a, b) => b - a);
            const yearSelect = document.getElementById('yearFilter');
            yearSelect.innerHTML = '<option value="">Alle</option>' + 
                years.map(year => `<option value="${year}">${year}</option>`).join('');
        }

        // Modal functions
        function openAlbumDetail(albumId) {
            const album = albums.find(a => a.id === albumId);
            if (!album) return;

            const modalContent = document.getElementById('modalContent');
            modalContent.innerHTML = `
                <center><h2>‚ïê‚ïê‚ïê ${album.title} ‚ïê‚ïê‚ïê</h2></center>
                
                <table width="100%">
                    <tr>
                        <td><b>K√ºnstler:</b></td>
                        <td>${album.artist}</td>
                    </tr>
                    <tr>
                        <td><b>Bewertung:</b></td>
                        <td><span class="rating">${album.rating.toFixed(1)}/10</span></td>
                    </tr>
                    ${album.year ? `<tr><td><b>Jahr:</b></td><td>${album.year}</td></tr>` : ''}
                    ${album.genre ? `<tr><td><b>Genre:</b></td><td>${album.genre}</td></tr>` : ''}
                    <tr>
                        <td><b>Fazit:</b></td>
                        <td>${album.review}</td>
                    </tr>
                </table>
                
                <hr>
                
                <h3>‚ïê‚ïê‚ïê SONGS (${album.tracks.length}) ‚ïê‚ïê‚ïê</h3>
                <table width="100%">
                    <tr>
                        <th>Nr.</th>
                        <th>Titel</th>
                        <th>Rating</th>
                        <th>Kommentar</th>
                    </tr>
                    ${album.tracks.map((track, index) => `
                        <tr>
                            <td>${index + 1}</td>
                            <td><b>${track.title}</b></td>
                            <td><span class="rating">${track.rating.toFixed(1)}/10</span></td>
                            <td>${track.comment || '-'}</td>
                        </tr>
                    `).join('')}
                </table>
                
                ${isLoggedIn ? `
                <hr>
                <center>
                    <button onclick="closeModal(); deleteAlbum(${album.id})" style="background: #ff4444; color: white;">
                        üóëÔ∏è Album l√∂schen
                    </button>
                </center>
                ` : ''}
            `;

            document.getElementById('albumModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('albumModal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('albumModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>
